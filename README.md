# shaker-app

This is to highlight that using webpack/nextjs to bundle applications will not tree shake a single ES file that's generated by rollup or other build systems.

TLDR; don't use webpack and rollup to make contatenated files.

The preference is still for separation of files.

You can see this in how https://material-ui.com/ and https://lodash.com/ publish there modules.

This was also identified in:

react-router issues:

- https://github.com/ReactTraining/react-router/issues/6608
- https://github.com/ReactTraining/react-router/issues/6464

# Setup

git clone this repo then run the following commands:

```
npm i -g lerna yarn
yarn
lerna bootstrap
lerna run build
cd packages/small-package
yarn link
cd ..
cd ..
yarn link "@icehunter/small-package"
yarn dev
```

Open your browser to: http://localhost:3000/

You will notice it's ap age that has "Mew!" on it. Now run:

```
yarn analyze
```

When you open "./next/analyze/client.html" you will see that despite only using the "small" function in "pages/index.js" it is in fact loading "big" from the big package.

This repo does the exact same builds as material-ui:

- commonjs
- umd
- es (stage 1 only)
- esm (current version of node being used)

Rollup makes the UMD but it will also make single point entry files to illustrate the issues of single file use.

- lib/index.cjs.js
- lib/index.es.js

What is exported from the package.json is:

- main (for bundlers that don't support es)
- browser (this will be used for clientside bundling if available, and is set to the UMD version)
- module (for es bundlers)

Ignore the fact I use typescript the result is the same.

If you want to see how this affects it you can try two different methods.

By default "browser" is used. So delete that from the package.json of small-package and re-run it.

Now we see that the package is VERy small, it will use and transpile the esm folder by default.

Let's point module to "lib/index.es.js".

Anaylyzing this gives us the same issue as umd, it's a single file and can't be tree-shaking.

CommonJS of course can' be tree shaking so we don't need to check that; but you can if you want :)

So what does this mean for project setup?

Well:

nextjs and webpack by default will treeshake. Out of the box since version 2 of webpack.

It will flow down the chain of modules and transpile all things it needs to to perform the needed optimizations.

You can see that material-ui does not pull in it's full dependencies despite being included in a submodule.
